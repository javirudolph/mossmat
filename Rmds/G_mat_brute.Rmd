---
title: "G matrix - brute force"
output:
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(ggpubr)
library(corrplot)
```


```{r}
traits <- readRDS("cleandata/traits_clean.RDS")
vocs <- readRDS("cleandata/clustered_voc_data.RDS")
str(vocs)


vocs %>% 
  mutate_at(vars(starts_with("c")), list(~ log10(. + 1))) %>% 
  mutate_at(vars(starts_with("c")), scale) -> vocs


theme_set(theme_bw())
```


# Data transformation
There are NAs in the data since some traits weren't measured. These are a problem when we do a log transformation. In my opinion, I wouldn't do a log transformation, just scale the variables. Specially for the days21 variable, we have lots of zeroes and will probably run into trouble there.

```{r}

traits %>% 
  select(-c(famid, sampid, ssex, raw_repro)) %>% 
  gather(key = "trait", value = "raw_values") %>% 
  ggplot(aes(x = raw_values, y = ..density..)) +
  geom_histogram(na.rm = TRUE, fill = "#8e9998") +
  facet_wrap( ~ trait, scales = "free")

```

If we scale the variables, they all look normal, except for days 21 and days gam. Which makes sense because these are different variables, they are not measurements, they are time to an event.

```{r}
traits %>% 
  select(-c(famid, sampid, ssex, raw_repro)) %>%
  #mutate_all(log10) %>% 
  mutate_all(scale) %>% 
  gather(key = "trait", value = "standardized_values") %>% 
  ggplot(aes(x = standardized_values, y = ..density..)) +
  geom_histogram(na.rm = TRUE, fill = "#87afac") +
  facet_wrap( ~ trait, scales = "free")
```

#Scaling volatile data
```{r}
vocs %>% 
  select(-c(famid, sampid, ssex)) %>%
  mutate_all(scale) %>% 
  gather(key = "trait", value = "standardized_values") %>% 
  ggplot(aes(x = standardized_values, y = ..density..)) +
  geom_histogram(na.rm = TRUE, fill = "#8766a8") +
  facet_wrap( ~ trait, scales = "free")

```

#Scaling traits 
```{r}
traits %>% 
  mutate_at(c(5:15), scale) -> scaled_traits

#Combining volatile and life history data into one master file. Scaling can occur prior to combining because the function works row by row
master <- full_join(x = scaled_traits, y = vocs)
```

# JUST TRAITS DATA
FEMALE TRAIT COVARIANCE MATRIX
```{r}


scaled_traits %>% 
  filter(ssex == "f") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_fems

cov_mat_fems %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "magma") +
  theme(axis.text.x = element_text(angle = 90))
```

Correlation matrix females life history traits
```{r}
cov_mat_fems <- as.matrix(cov_mat_fems)
cor_mat_fems <- (cov2cor(cov_mat_fems))
females_life <- corrplot(cor_mat_fems)
```

MALE TRAIT COVARIANCE MATRIX
```{r}
scaled_traits %>% 
  filter(ssex == "m") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_male

cov_mat_male %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90))
```

Correlation matrix males life history traits
```{r}
cov_mat_male <- as.matrix(cov_mat_male)
cor_mat_male <- (cov2cor(cov_mat_male))
Males_life <- corrplot(cor_mat_male)
```

#ALL TRAIT DATA COVARIANCE MATRIX but not seperated by sex.
```{r}
scaled_traits %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_all

cov_mat_all %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma") +
  theme(axis.text.x = element_text(angle = 90))

```

Correlation matrix for all life history traits
```{r}

cov_mat_all <- as.matrix(cov_mat_all)
cor_mat_all <- (cov2cor(cov_mat_all))
Males_life <- corrplot(cor_mat_all)
```

#All traits by filtering with only families shared between males and females. Plotted males vs females
All traits filtered males v females covariance
```{r}


scaled_traits %>% 
  filter(ssex == "m") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() -> male_data

scaled_traits %>% 
  filter(ssex == "f") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  filter(famid %in% male_data$famid) -> fem_data

# Use only the families that have both males and females
test_cov <- cov(male_data[,2:12], fem_data[,2:12], use = "pairwise.complete.obs")
test_cor <- cor(male_data[,2:12], fem_data[,2:12])


test_cov %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90))

```

All traits filtered males v females correlation
```{r}

test_cor %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90))
```


# Just VOCs
Female volatiles covariance plot

```{r}
vocs %>% 
  filter(ssex == "f") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_fems

cov_mat_fems %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "magma") +
  theme(axis.text.x = element_text(angle = 90))

```

Female volatiles correlation plot
```{r}
cov_mat_fems <- as.matrix(cov_mat_fems)
cor_mat_fems <- (cov2cor(cov_mat_fems))
females_voc <- corrplot(cor_mat_fems)
```

Male volatile covariance matrix
```{r}
vocs %>% 
  filter(ssex == "m") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_male

cov_mat_male %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90))

```

Male volatile correlation matrix
```{r}

cov_mat_male <- as.matrix(cov_mat_male)
cor_mat_male <- (cov2cor(cov_mat_male))
males_voc <- corrplot(cor_mat_male)
```

#All data not female vs male
```{r}
vocs %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_all

cov_mat_all %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma") +
  theme(axis.text.x = element_text(angle = 90))


```

Male volatile correlation matrix
```{r}
cov_mat_all <- as.matrix(cov_mat_all)
cor_mat_all <- (cov2cor(cov_mat_all))
all_VOC <- corrplot(cor_mat_all)
```

#All vocs filtered by those with Male and female families. Plot M v F
Male vs female covariance
```{r, eval = FALSE}
vocs %>% 
  filter(ssex == "m") %>% 
  group_by(famid) %>% 
  mutate_at(c(4:18), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex)) %>% 
  distinct() -> male_data

vocs %>% 
  filter(ssex == "f") %>% 
  group_by(famid) %>% 
  mutate_at(c(4:18), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex)) %>% 
  distinct() %>% 
  filter(famid %in% male_data$famid) -> fem_data

# Use only the families that have both males and females

fem_data %>%
  filter(famid %in% male_data$famid) -> fem_data

test_cov <- cov(male_data[,2:16], fem_data[,2:16], use = "na.or.complete")
test_cor <- cor(male_data[,2:16], fem_data[,2:16], use = "na.or.complete")

#Male vs female covariance
test_cov %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90))


```

Male vs female correlation
```{r}
test_cor %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90))
```

# Combined life history and volatile data
Female all covariance
```{r}
#Female data combined
master %>% 
  filter(ssex == "f") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:30), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_fems

#Female all covariance
cov_mat_fems %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "magma") +
  theme(axis.text.x = element_text(angle = 90))


```

Female all correlation
```{r}

cov_mat_all <- as.matrix(cov_mat_all)
cor_mat_all <- (cov2cor(cov_mat_all))
all_VOC <- corrplot(cor_mat_all)

```

#All data for males
```{r}
master %>% 
  filter(ssex == "m") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:30), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_male

#Covariance matrix for males for all data
cov_mat_male %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme(axis.text.x = element_text(angle = 90))

```

male all correlation
```{r}
#
cov_mat_male <- as.matrix(cov_mat_male)
cor_mat_male <- (cov2cor(cov_mat_male))
all_male <- corrplot(cor_mat_male)
```


#All data but not filtered by sex
All data covariance
```{r}
#All data but not filtered by sex
master %>% 
  group_by(famid) %>% 
  mutate_at(c(5:30), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_all

#All data covariance
cov_mat_all %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma") +
  theme(axis.text.x = element_text(angle = 90))


```

all data correlation
```{r}

cov_mat_all <- as.matrix(cov_mat_all)
cor_mat_all <- (cov2cor(cov_mat_all))
all_alle <- corrplot(cor_mat_all)
```

#ALl data filtered by males v females
Covariance for males v female for all data
```{r eval = FALSE}


master %>% 
  filter(ssex == "m") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:30), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() -> male_data

master %>% 
  filter(ssex == "f") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:30), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  filter(famid %in% male_data$famid) -> fem_data

# Use only the families that have both males and females
#Covariance for males v female for all data
test_cov <- cov(male_data[,2:12], fem_data[,2:12], use = "na.or.complete")
test_cor <- cor(male_data[,2:12], fem_data[,2:12], use = "na.or.complete")

test_cov %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90))


```

Correlation for all data for males vs females
```{r}
#Correlation for all data for males vs females
test_cor %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90))
```



Correlation using only the females that have both males and females
```{r}
# Correlation using only the females that have both males and females

test_cor <- cor(male_data[,2:12], fem_data[,2:12], use = "na.or.complete")


corrplot(test_cor)

test_cor %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90))

```


