---
title: "Cleaning_matrix"
author: "Leslie Kollar"
date: "1/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE, message = FALSE, fig.width = 40, fig.height = 20)
```


```{r libraries, message=FALSE}
library(tidyverse)
library(vegan)
library(plotly)
library(corrplot)
library(ggpubr)
library(Hmisc)
library(vegan)
library(reshape2)
theme_set(theme_bw())
```

Reading in the data
```{r}
# Read in the raw data
master <- read.csv("rawdata/LK_master.csv", stringsAsFactors = FALSE)
master <- master[1:619,]
```

#Goals of this code
Here, we are cleaning the entire matrix data set in order to use in the matrix componnent of the manuscipt

## Trait data
We would also like to remove empty rows at the end, manage the zeroes and NAs. There are some errors in measurements and typos that we need to address. 

```{r}
# Change variable names and fix sample ID names with spaces, or parentheses

trait_raw <- master[,1:19] %>% 
  rename(famid = Fam..,
         sampid = Sample.Name,
         ssex = Sample_Sex) %>% 
  drop_na(famid) %>% 
  mutate(sampid = str_replace_all(sampid, "\\(.*\\)", ""),
         sampid = str_trim(sampid, side = "both"),
         ssex = str_to_lower(as.character(ssex))) %>% # Sex on lower case only
  mutate_at(vars(starts_with("Leaf")), as.numeric) %>% # Make them all numeric 
  group_by(famid) %>% 
  arrange(sampid, .by_group = TRUE) %>% # Order by family number
  ungroup

# Fix a data entry error:
trait_raw$Avg_21_days[which(trait_raw$Avg_21_days == 33)] <- 0.33

# Fix sex data entry error
trait_raw[which(trait_raw$sampid == "P_18_1_6_B"),]$ssex <- "m"
trait_raw <- trait_raw[-which(trait_raw$sampid == "P_6_6_20"),]

head(trait_raw)
```
```{r}
# Removing DIV/0 from the data set
trait_raw$Leaf_Average_Area <-  as.numeric(str_replace(trait_raw$Leaf_Average_Area, "#DIV/0", "NA"))
trait_raw$Leaf_Length_Average <-  as.numeric(str_replace(trait_raw$Leaf_Length_Average, "#DIV/0", "NA"))
trait_raw$Leaf_perimeter_average <-  as.numeric(str_replace(trait_raw$Leaf_perimeter_average, "#DIV/0", "NA"))

```

# Removing May 23, 29, and 30
```{r}
trait_raw %>% 
  filter(Date.PTR!= "30-May") %>%
  mutate_if(is.numeric, list(~ ifelse(. < 0, 0, .))) %>% 
  arrange(sampid, .by_group = TRUE)-> trait_raw_3

trait_raw_3 %>% 
  filter(Date.PTR != "29-May") %>%
  mutate_if(is.numeric, list(~ ifelse(. < 0, 0, .))) %>% 
  arrange(sampid, .by_group = TRUE) -> trait_raw_2

trait_raw_2 %>% 
  filter(Date.PTR != "23-May") %>%
  mutate_if(is.numeric, list(~ ifelse(. < 0, 0, .))) %>% 
  arrange(sampid, .by_group = TRUE) -> trait_raw
```

#### Leaf traits
First, we visually check for outliers or values that may not make sense. There are NAs in the dataset which will be problematic but some will be taken care of when we average them
```{r}
# Leaf data averaging 
trait_raw[,17:19] %>% 
  gather(key = "trait", value = "value") %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()
```
There are no clear outliers or errors, so these look ok to average and we create a new data frame with the leaf data. In cases where data for only one of the clones was available, we kept that value. For cases where data was available for both clones we averaged it.  

#Averaging clones for leaf data and removing NAs
```{r}
trait_raw[,c(2, 17:19),] %>% 
  group_by(sampid) %>% # sampid is the unique identifier for the clones
  summarise_at(vars(starts_with("Leaf")), mean, na.rm = TRUE) %>% 
  mutate_at(vars(starts_with("Leaf")), list(~ as.numeric(ifelse(. == "NaN", "NA", .)))) %>% 
  drop_na(sampid)-> leaf_data

# Some NAs
leaf_data[!complete.cases(leaf_data), ]

#Viewing the data after averaging clones
leaf_data[,2:4] %>% 
  gather(key = "trait", value = "value") %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()

```
There are still some NAs. I am not sure if I should set those to zero.


#### Growth and development traits
We do the same thing with these other traits and it is easy to identify three values that seem incorrect. These are in the area, circularity and perimeter rate.

```{r}
# Growth and Development traits -------------------------------------------

trait_raw[,10:16] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()
```
#Removing outliers for the growth data
```{r}
outliers_area <- which(trait_raw$Avg_Area._Week_3>50)
trait_raw[outliers_area,]

outliers_circ <- which(trait_raw$Avg_Circularity_Week.3>50)
trait_raw[outliers_circ,]

outliers_Gam <- which(trait_raw$Avg_Days_til_Gam>25)
trait_raw[outliers_Gam,]




```

```{r}
trait_raw$Avg_Area._Week_3[outliers_area] <- trait_raw$Avg_Area._Week_3[outliers_area] / 1000
trait_raw$Avg_Circularity_Week.3[outliers_circ] <- trait_raw$Avg_Circularity_Week.3[outliers_circ] / 1000
trait_raw$Avg_Days_til_Gam[outliers_Gam] <- (trait_raw$Avg_Days_til_Gam[outliers_Gam] == 0) 

# check again 
trait_raw[,10:16] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()
```

These values had mistakes in the number of decimal places and included a typo making a value be negative. After adjusting these values, we check again for errors. The data looks ok now, so we can save the dataframe.
```{r}
negs <- which(trait_raw$Avg_Perimeter_Rate < 0)
trait_raw[negs,]

trait_raw$Avg_Perimeter_Rate[negs]
trait_raw$Avg_Perimeter_Rate[negs] <- trait_raw$Avg_Perimeter_Rate[negs] /-10

# Check visually
trait_raw[,10:16] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()
```

#Output final data for growth and development data
```{r}
trait_raw[,c(2, 10:16)] %>% 
  drop_na() %>% 
  distinct()-> gro_dev_data
```

#### Reproduction variable
We have different reproduction variables for females and females, so we can scale them and that way keep them under one variable only. This could be wrong, but I honestly don't know what else we could do.
The first thing we do here is take the average for the clones (meaning we group by the sample ID, take the average) which we call `raw_av` and then scale this so that both female and female values are in the same *scale*, and we call this `reprovar`.

```{r}
# Reproduction variable ---------------------------------------------------
trait_raw %>% 
  filter(ssex == "m") %>% 
  select(sampid, ssex, Avg_Male_Buds.Stem)%>% 
  drop_na() %>% 
  group_by(sampid) %>% 
  summarise(raw_av = mean(Avg_Male_Buds.Stem)) %>% 
  mutate(reprovar = scale(raw_av),
         ssex = "m")  -> male_reprovar

trait_raw %>% 
  select(sampid, ssex, Avg_Arch) %>% 
  filter(ssex == "f") %>% 
  drop_na() %>% 
  group_by(sampid) %>% 
  summarise(raw_av = mean(Avg_Arch)) %>% 
  mutate(reprovar = scale(raw_av),
         ssex = "f") -> fem_reprovar


reprovar <- bind_rows(fem_reprovar, male_reprovar)
head(reprovar)
reprovar %>% 
  ggplot(aes(x = reprovar, fill = ssex)) +
  geom_histogram()
```

### Clean trait data
We can now join all the smaller datasets and have a master traits data frame. These are not scaled so far and we can evaluate the changes of scaling them vs keeping them as they are.

```{r}
# Join trait data ---------------------------------------------------------
trait_raw %>% 
  select(famid, sampid, ssex) %>% 
  distinct() %>% 
  full_join(., reprovar) %>% 
  full_join(., gro_dev_data) %>%
  full_join(., leaf_data) %>% 
  set_names(c("famid", "sampid", "ssex", "raw_repro", "repro", "area_wk3",
              "perim_wk3", "circ_wk3", "perim_rate", "area_rate",
              "days21", "days_gam", "leaf_length", "leaf_area",
              "leaf_perim")) -> traits

saveRDS(traits, "cleandata/clean_traits_final.RDS")

```

#### Histograms raw trait data
These are the values for all the traits that were measured and they include only one value per individual. Here, I consider an individual to each of the siblings. This means that we have averaged the measurements associated to clonal replicates, so we get an average of measurements per sibling.

```{r}
traits %>% 
  select(-c(famid, sampid, ssex, raw_repro)) %>% 
  gather(key = "trait", value = "raw_values") %>% 
  ggplot(aes(x = raw_values, y = ..density..)) +
  geom_histogram(na.rm = TRUE, fill = "#8e9998") +
  facet_wrap( ~ trait, scales = "free")
```

#### Histograms transformed trait data
It depends on what we need and how the data needs to be formatted.  
If we log transform the data and then scale it, the following figure shows the histograms for all the variables. Since we have variables in different units, we would probably use the scaled traits for future analyses and models.

I dont think we need to log transform this data

```{r}
names(traits)
traits %>% 
  mutate_at(c(5:15), list(~ log10(. + 1))) %>% 
  mutate_at(c(5:15), scale) -> scaled_traits

scaled_traits %>% 
  select(-c(famid, sampid, ssex, raw_repro)) %>% 
  gather(key = "trait", value = "raw_values") %>% 
  ggplot(aes(x = raw_values, y = ..density..)) +
  geom_histogram(na.rm = TRUE, fill = "#7e9bcc") +
  facet_wrap( ~ trait, scales = "free")
```


#Working with VOC data
```{r}
# Just keep volatile data and identifiers
# Also, remove the NAs, there's a lot at the end
# Remove '(2)' notation from sample ids

#names(rawdata)
voc_raw <- master[,c(1,2,4,5, 20:109)] %>% 
  rename(famid = Fam..,
         sampid = Sample.Name,
         ssex = Sample_Sex) %>% 
  drop_na() %>% 
  mutate(sampid = str_replace_all(sampid, "\\(.*\\)", ""),
         sampid = str_trim(sampid, side = "both"),
         ssex = str_to_lower(as.character(ssex)))

#Shorten voc names
oldnames <- names(voc_raw)
names(voc_raw)[5:94] <- stringr::str_trunc(oldnames[5:94], width = 6, side = "right", ellipsis = "")
```

There was an issue with the notation in one of the compounds, so we check that and fix the notation so that R can recognize the values as numbers.
```{r}
#str(voc_raw)
#' m111.0 is a character
#voc_raw$m111.0
#' The notation is different, using a capital E
voc_raw$m111.0 <- as.numeric(str_replace(voc_raw$m111.0, "E", "e"))
```
# Removing May 23, 29, and 30
```{r}
voc_raw %>% 
  filter(Date.PTR!= "30-May") %>%
  mutate_if(is.numeric, list(~ ifelse(. < 0, 0, .))) %>% 
  arrange(sampid, .by_group = TRUE)-> vocs

vocs %>% 
  filter(Date.PTR != "29-May") %>%
  mutate_if(is.numeric, list(~ ifelse(. < 0, 0, .))) %>% 
  arrange(sampid, .by_group = TRUE) -> vocs_2

vocs_2 %>% 
  filter(Date.PTR != "23-May") %>%
  mutate_if(is.numeric, list(~ ifelse(. < 0, 0, .))) %>% 
  arrange(sampid, .by_group = TRUE) -> vocs_3
```

# 10% threshold 
```{r}
# Create a dataset with only the compounds for which at least 10% of the observations show it.
vocs_3 %>% 
  select(-famid, -sampid, -ssex, -Date.PTR) %>% 
  mutate_if(is.numeric, function(x) ifelse(x > 0, 1, 0)) %>% 
  colSums() %>% 
  data.frame() %>% 
  rownames_to_column() %>%
  setNames(., c("voc", "count")) %>% 
  mutate(prcnt = count/nrow(vocs)) %>% 
  filter(prcnt >= 0.1) -> voc_filter

#vocs_3 %>% 
#  select(famid, sampid, ssex, Date.PTR, c(voc_filter$voc)) %>% 
#  mutate(ssex = str_to_lower(as.character(ssex))) -> voc_data

#Taking the max for each VOC
#The distinct function is not working
vocs_3 %>% 
  select(famid, sampid, ssex, c(voc_filter$voc)) %>% 
  group_by(sampid) %>%
  mutate_at(vars(starts_with("m")), max) %>% # This is selecting the maximum value for all the volatiles
  distinct() -> voc_data
```


# Exploration with clones
```{r}
long_voc_data <- voc_data %>% 
  gather(., key = "voc", value = "conc", -c(famid, sampid, ssex)) %>% 
  mutate(voc = factor(voc, levels = unique(voc)))

long_voc_data %>%
  ggplot(aes(x = voc, y = conc)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90))

long_voc_data %>% 
  filter(conc > 0) %>%
  ggplot(aes(x = voc, y = conc)) + 
  geom_boxplot() +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_log10()

```

We see that there are three big outliers. The values are so small and over the machine's detection thresold, so we will make them equal to zero.

```{r}
# Making these outliers be zero
voc_data[voc_data < 1e-15 & voc_data>0] <- 0

#Cuttoff at 10e-10 in original data file
voc_data[voc_data < 10e-10] <- 0

long_voc_data <- voc_data %>% 
  gather(., key = "voc", value = "conc", -c(famid, sampid, ssex)) %>% 
  mutate(voc = factor(voc, levels = unique(voc)))


```

voc_data is the cleaned data for the matrix

```{r eval = FALSE}
#Plotting log data
long_voc_data %>% 
  ggplot(aes(x = voc, y = conc)) + 
  geom_boxplot() +
  theme_bw() + 
  lims(y = c(1e-13, 1e-03)) +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_log10()
```


#Log transformation

```{r, fig.width=2.75,fig.height=4.5}
#Log transform data but add 1e-12 to zeros because you cannot log transform zeros
log_vocs <- voc_data %>% 
  mutate_at(vars(starts_with("m")), list(~ log10(. + 1e-12)))

#Checking for missing data- no missing cases
log_vocs[complete.cases(log_vocs),]
```

### Master dataframe
This will create the master data frame that includes the lifehistory traits and the VOC clustered data. Also, there is one row per individual, which means the data for clones has either been averaged(for traits) or the max value has been taken (volatiles).
```{r}

clean_master <- full_join(traits, voc_data) %>% 
  mutate_at(c(5:32), as.numeric)

#Setting NA to zero for the time being
clean_master[is.na(clean_master)]<-0

#Print master file (nothing is transformed because of zeros introduced by joining)
clean_master$Date.PTR <- NULL
print(clean_master)
write_csv(clean_master, "/Users/lesliekollar/Desktop/Moss_matrix/cleandata/clean_master_Jan_13.csv")

#Log transform only VOC data adding smallest value
clean_master_log <- clean_master %>% 
  mutate_at(vars(starts_with("m")), list(~ log10(. + 1e-12)))

#Seperating by sex for seperate analyses 

clean_master_log%>%
  filter(ssex=="m")%>%
  mutate_at(vars(starts_with("m")), scale)-> male_master_log_scale

clean_master_log%>%
  filter(ssex=="f")%>%
  mutate_at(vars(starts_with("m")), scale)-> female_master_log_scale

#Scaling the VOC data for all
clean_master_log_scaled <- clean_master_log %>% 
  mutate_at(vars(starts_with("r")), scale)



saveRDS(clean_master_log_scaled, "cleandata/clean_master_matrix_scaled_log.RDS")
saveRDS(clean_master, "cleandata/clean_master_matrix.RDS")
saveRDS(clean_master_log, "cleandata/clean_master_matrix_log_voc.RDS")

#Still some NAs

#Scaling sex specific data
clean_master_scaled_VOCs_males<- male_master_log_scale %>% 
  mutate_at(vars(starts_with("m")), scale)

clean_master_scaled_VOCs_females<- female_master_log_scale %>% 
  mutate_at(vars(starts_with("m")), scale)

#Run PCA
#Cannot run on missing values...
#Scale only VOCs because there isnt missing data and we can move forward with sex sepcific VOC PCA
clean_master_scaled_VOCs <- rda(clean_master_log_scaled[,16:88])

# Figure for log transformed data
biplot(clean_master_scaled_VOCs, display = c("sites", 
                   "species"),
       type = c("text",
                "points"))
ssex.colors <- levels(factor(log_vocs$ssex))
ordihull(log_pca, group = factor(log_vocs$ssex),
         col = c("green","blue"))
legend("topright", 
       col = c("green", "blue"),
       lty = 1,
       legend = ssex.colors)

#females
clean_master_scaled_VOCs_females_pca <- rda(clean_master_scaled_VOCs_females[,16:88])

# Figure for log transformed data
biplot(clean_master_scaled_VOCs_females_pca, display = c("sites", 
                   "species"),
       type = c("text",
                "points"))


#males
clean_master_scaled_VOCs_males_pca <- rda(clean_master_scaled_VOCs_males[,16:88])

# Figure for log transformed data
biplot(clean_master_scaled_VOCs_males_pca, display = c("sites", 
                   "species"),
       type = c("text",
                "points"))

```
I am not sure I see a different in the log transformed data and the logtransformed + scaled data. I think moving forward its best to use the logtransformed and scaled data.

### PCA reducation chosing axes that explain 80% of the total variance and eigenvalues have to be above 1
```{r}
#Scree plot shows a lot of the variation is explained in PC1
#screeplot(log_st_pca)
#abline(a=1,b=0)

## How do we know how many to chose?
#summary(log_st_pca)

#Expressed as cummalitve percentages
#round(cumsum(100*log_st_pca$CA$eig/sum(log_st_pca$CA$eig)),2)

################
#females: Scree plot shows a lot of the variation is explained in PC1
screeplot(clean_master_scaled_VOCs_females_pca)
abline(a=1,b=0)

## How do we know how many to chose?
summary(clean_master_scaled_VOCs_females_pca)

#Expressed as cummalitve percentages
round(cumsum(100*clean_master_scaled_VOCs_females_pca$CA$eig/sum(clean_master_scaled_VOCs_females_pca$CA$eig)),2)


#males: Scree plot shows a lot of the variation is explained in PC1
screeplot(clean_master_scaled_VOCs_males_pca)
abline(a=1,b=0)

## How do we know how many to chose?
summary(clean_master_scaled_VOCs_males_pca)

#Expressed as cummalitve percentages
round(cumsum(100*clean_master_scaled_VOCs_males_pca$CA$eig/sum(clean_master_scaled_VOCs_males_pca$CA$eig)),2)
```


```{r}
#females
library(lme4)
VOC_traits_female_1 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,1]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro+ famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_1)

VOC_traits_female_2 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,2]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_2)

VOC_traits_female_3 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,3]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_3)

VOC_traits_female_4 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,4]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_4)

VOC_traits_female_5 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,5]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_5)

VOC_traits_female_6 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,6]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_6)

VOC_traits_female_7 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,7]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro+ famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_7)

VOC_traits_female_8 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,8]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro+ famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_8)

VOC_traits_female_9 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,9]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro+ famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_9)

VOC_traits_female_10 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,10]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_10)

VOC_traits_female_11 <- lm(clean_master_scaled_VOCs_females_pca$CA$u[,11]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_females, REML = FALSE, na.action = na.omit)

summary(VOC_traits_female_10)
```

```{r}
#Males
VOC_traits_male_1 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,1]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro+ famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_1)

VOC_traits_male_2 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,2]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro+ famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_2)

VOC_traits_male_3 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,3]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_3)

VOC_traits_male_4 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,4]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_4)

VOC_traits_male_5 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,5]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_5)

VOC_traits_male_6 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,6]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_6)

VOC_traits_male_7 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,7]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro+ famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_7)

VOC_traits_male_8 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,8]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro+ famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_8)

VOC_traits_male_9 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,9]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+ repro+ famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_9)

VOC_traits_male_10 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,10]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_10)

VOC_traits_male_11 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,11]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_11)

VOC_traits_male_12 <- lm(clean_master_scaled_VOCs_males_pca$CA$u[,12]~ area_wk3 + perim_wk3 +  circ_wk3+ days21+ days_gam+ leaf_length+ leaf_area+ leaf_perim+  repro+famid ,data = clean_master_scaled_VOCs_males, REML = FALSE, na.action = na.omit)

summary(VOC_traits_male_12)

```

```{r}
#Full model for each VOC
dvList <- names(clean_master_log)[16:88]
model <- lapply(dvList, function(x) {
    lmer(substitute(i~ssex + (1|famid) + (1|famid:ssex), list(i = as.name(x))), data = clean_master_log, REML = FALSE, na.action = na.omit)})
lapply(model, summary)


#Pulling out coefficients
sapply(model, coef)

#Pulling out BICs
sapply(model, BIC)  

#removed sex
dvList <- names(clean_master_log)[16:88]
model_1 <- lapply(dvList, function(x) {
    lmer(substitute(i~ + (1|famid) + (1|famid:ssex), list(i = as.name(x))), data = clean_master_log, REML = FALSE, na.action = na.omit)})
lapply(model, summary)
sapply(model, coef)  

BIC_compare_sex_VOCs <- sapply(model_1, BIC)- sapply(model, BIC)

#removed family

dvList <- names(clean_master_log)[16:88]
model_2 <- lapply(dvList, function(x) {
    lmer(substitute(i~ssex  + (1|famid:ssex), list(i = as.name(x))), data = clean_master_log, REML = FALSE, na.action = na.omit)})
lapply(model_2, summary)
sapply(model_2, coef)  

BIC_compare_Fam_VOCs <- sapply(model, BIC)- sapply(model_2, BIC)

#removed family:sex interaction
dvList <- names(clean_master_log)[16:88]
model_3 <- lapply(dvList, function(x) {
    lmer(substitute(i~ssex  + (1|famid), list(i = as.name(x))), data = clean_master_log, REML = FALSE, na.action = na.omit)})
lapply(model, summary)
sapply(model, coef)  

BIC_compare_FamSex_VOCs <- sapply(model, BIC)- sapply(model_3, BIC)

```

#Calculating variances for each VOC
```{r}
#Using transformed data because that will give a better estimate of the parameters

m30 <- lmer(clean_master_log$m30.99  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m30.99 <- lsmeans(m30, ~ssex)

m31 <- lmer(clean_master_log$m31.01  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m31 <- lsmeans(m31, ~ssex)

m31.99 <- lmer(clean_master_log$m31.99  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m31.99 <- lsmeans(m31.99, ~ssex)

m33 <- lmer(clean_master_log$m33.03  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m33 <- lsmeans(m33, ~ssex)

m34 <- lmer(clean_master_log$m34.02  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m34 <- lsmeans(m34, ~ssex)

m37 <- lmer(clean_master_log$m37.02  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m37 <- lsmeans(m37, ~ssex)

m39 <- lmer(clean_master_log$m39.03  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m39 <- lsmeans(m39, ~ssex)

m41 <- lmer(clean_master_log$m41.03  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m41 <- lsmeans(m41, ~ssex)

m42 <- lmer(clean_master_log$m42.03  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m42 <- lsmeans(m42, ~ssex)

m43 <- lmer(clean_master_log$m43.01  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m43 <- lsmeans(m43, ~ssex)

m44 <- lmer(clean_master_log$m44.06  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m44 <- lsmeans(m44, ~ssex)

m45 <- lmer(clean_master_log$m45.03  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m45 <- lsmeans(m45, ~ssex)

m46 <- lmer(clean_master_log$m46.03  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m46 <- lsmeans(m46, ~ssex)

m47 <- lmer(clean_master_log$m47.01  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m47 <- lsmeans(m47, ~ssex)

m47.98 <- lmer(clean_master_log$m47.98  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m47.98 <- lsmeans(m47.98, ~ssex)

m49 <- lmer(clean_master_log$m49.02  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m49 <- lsmeans(m49, ~ssex)

m49.05 <- lmer(clean_master_log$m49.05  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m49.05 <- lsmeans(m49.05, ~ssex)

m49.99 <- lmer(clean_master_log$m49.99  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m49.99 <- lsmeans(m49.99, ~ssex)

m55 <- lmer(clean_master_log$m55.03  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m55 <- lsmeans(m55, ~ssex)

m57.05 <- lmer(clean_master_log$m57.05  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m57.05 <- lsmeans(m57.05, ~ssex)

m59 <- lmer(clean_master_log$m59.04  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m59 <- lsmeans(m59, ~ssex)

m61 <- lmer(clean_master_log$m61.02  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m61 <- lsmeans(m61, ~ssex)

m62 <- lmer(clean_master_log$m62.02  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m62 <- lsmeans(m62, ~ssex)

m63 <- lmer(clean_master_log$m63.02  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m63 <- lsmeans(m63, ~ssex)

m69 <- lmer(clean_master_log$m69.00  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m69 <- lsmeans(m69, ~ssex)

m69.06 <- lmer(clean_master_log$m69.06  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m69.06 <- lsmeans(m69.06, ~ssex)

m71 <- lmer(clean_master_log$m71.03  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m71 <- lsmeans(m71, ~ssex)

m73 <- lmer(clean_master_log$m73.03  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m73 <- lsmeans(m73, ~ssex)

m75 <- lmer(clean_master_log$m75.04  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m75 <- lsmeans(m75, ~ssex)

m77 <- lmer(clean_master_log$m77.05  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m77 <- lsmeans(m77, ~ssex)

m79 <- lmer(clean_master_log$m79.05  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m79 <- lsmeans(m79, ~ssex)

m81 <- lmer(clean_master_log$m81.06  ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m81 <- lsmeans(m81, ~ssex)

m83 <- lmer(clean_master_log$m83.05 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m83 <- lsmeans(m83, ~ssex)

m85 <- lmer(clean_master_log$m85.06 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m85 <- lsmeans(m85, ~ssex)

m86 <- lmer(clean_master_log$m86.03 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m86 <- lsmeans(m86, ~ssex)

m87 <- lmer(clean_master_log$m87.04 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m87 <- lsmeans(m87, ~ssex)

m89 <- lmer(clean_master_log$m89.05 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m89 <- lsmeans(m89, ~ssex)

m89.09 <- lmer(clean_master_log$m89.09 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m89.09 <- lsmeans(m89.09, ~ssex)

m91 <- lmer(clean_master_log$m91.00 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m91 <- lsmeans(m91, ~ssex)

m93 <- lmer(clean_master_log$m93.06 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m93 <- lsmeans(m93, ~ssex)

m95 <- lmer(clean_master_log$m95.00 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m95 <- lsmeans(m95, ~ssex)

m97 <- lmer(clean_master_log$m97.00 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m97 <- lsmeans(m97, ~ssex)

m98 <- lmer(clean_master_log$m98.00 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m98 <- lsmeans(m98, ~ssex)

m99 <- lmer(clean_master_log$m99.08 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m99 <- lsmeans(m99, ~ssex)


m100<- lmer(clean_master_log$m100.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m100 <- lsmeans(m100, ~ssex)

m101<- lmer(clean_master_log$m101.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m101 <- lsmeans(m101, ~ssex)

m103<- lmer(clean_master_log$m103.1~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m103 <- lsmeans(m103, ~ssex)

m105<- lmer(clean_master_log$m105_F~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m105 <- lsmeans(m105, ~ssex)

m106<- lmer(clean_master_log$m106.0~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m106 <- lsmeans(m106, ~ssex)

m107<- lmer(clean_master_log$m107.0~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m107 <- lsmeans(m107, ~ssex)

m108<- lmer(clean_master_log$m108.0~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m108 <- lsmeans(m108, ~ssex)

m109<- lmer(clean_master_log$m109.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m109 <- lsmeans(m109, ~ssex)

m111<- lmer(clean_master_log$m111.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m111 <- lsmeans(m111, ~ssex)

m113<- lmer(clean_master_log$m113.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m113 <- lsmeans(m113, ~ssex)

m115<- lmer(clean_master_log$m115.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m115 <- lsmeans(m115, ~ssex)

m119<- lmer(clean_master_log$m119.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m119 <- lsmeans(m119, ~ssex)

m121<- lmer(clean_master_log$m121.1 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m121 <- lsmeans(m121, ~ssex)

m124<- lmer(clean_master_log$m124.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m124 <- lsmeans(m124, ~ssex)

m125<- lmer(clean_master_log$m125.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m125 <- lsmeans(m125, ~ssex)

m127<- lmer(clean_master_log$m127.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m127 <- lsmeans(m127, ~ssex)

m129<- lmer(clean_master_log$m129.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m129 <- lsmeans(m129, ~ssex)

m130<- lmer(clean_master_log$m130.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m130 <- lsmeans(m130, ~ssex)

m135<- lmer(clean_master_log$m135.1 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m135 <- lsmeans(m135, ~ssex)

m137<- lmer(clean_master_log$m137.1 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m137 <- lsmeans(m137, ~ssex)

m139<- lmer(clean_master_log$m139.1 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m139 <- lsmeans(m139, ~ssex)

m143<- lmer(clean_master_log$m143.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m143 <- lsmeans(m143, ~ssex)

m149<- lmer(clean_master_log$m149.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m149 <- lsmeans(m149, ~ssex)

m150<- lmer(clean_master_log$m150.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m150 <- lsmeans(m150, ~ssex)

m151<- lmer(clean_master_log$m151.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m151 <- lsmeans(m151, ~ssex)

m163<- lmer(clean_master_log$m163.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m163 <- lsmeans(m163, ~ssex)

m204<- lmer(clean_master_log$m204.0 ~ssex + (1|famid) + (1|famid:ssex), data = clean_master_log, REML = FALSE, na.action = na.omit)

ls_m204 <- lsmeans(m204, ~ssex)
```


```{r}
#Interaction plot (scatter plot with line of best fit)
voc_data_males <- clean_master_scaled_VOCs_males
voc_data_males$raw_repro <- NULL
voc_data_males$area_wk3 <- NULL
voc_data_males$perim_wk3 <- NULL
voc_data_males$circ_wk3 <- NULL
voc_data_males[,4:13] <- NULL
clean_master_log_all_voc <- clean_master_log

clean_master_log_all_voc[4:16] <- NULL

long_voc_data <- clean_master_log_all_voc %>% 
  gather(., key = "voc", value = "conc", -c(famid, sampid, ssex)) %>% 
  mutate(voc = factor(voc, levels = unique(voc)))

long_voc_data %>% 
  ggplot(aes(x = famid, y = conc, color = ssex)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm")+
  facet_wrap(~voc) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  scale_color_viridis_d(begin = 0.2, end = 0.8)
```



#############################################################################################################
#Covariance matrix for female life history triats
```{r}
mynamestheme <- theme(plot.title = element_text(family = "Arial", face = "bold", size = (20)), 
                 legend.title = element_text(colour = "black",  face = "bold.italic", family = "Arial"), 
                 legend.text = element_text(face = "italic", colour="black",family = "Arial"), 
                  axis.title = element_text(family = "Arial", size = (13), colour = "Black"),
                  axis.text = element_text(family = "Arial", colour = "black", size = (10)))


clean_master_log_scaled[,1:15] %>% 
  filter(ssex == "f") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_fems_traits

cov_mat_fems_traits %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  mynamestheme +
  ggtitle("Female Life History Trait Covariance Matrix")+
  scale_fill_gradient2(low = "#0000FF", mid = "#FFFFFF", high ="#FF0000")+
  theme(axis.text.x = element_text(angle = 90))
```

#Covariance matrix for female volatiles and traits
```{r}
female_master_log_scale %>% 
  group_by(famid) %>% 
  mutate_at(c(5:88), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_fems_all

cov_mat_fems_all %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  mynamestheme +
  ggtitle("female VOC history trait covariance matrix")+
  scale_fill_gradient2(low = "#0000FF", mid = "#FFFFFF", high ="#FF0000", limit= c(-100,400))+
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
#Male life history
clean_master_log_scaled[,1:15] %>% 
  filter(ssex == "m") %>% 
  group_by(famid) %>% 
  mutate_at(c(5:15), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_male_traits

cov_mat_male_traits %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  mynamestheme +
  ggtitle("male life history trait covariance matrix")+
  scale_fill_gradient2(low = "#0000FF", mid = "#FFFFFF", high ="#FF0000")+
  theme(axis.text.x = element_text(angle = 90))
```


```{r}
#Male VOCs
male_master_log_scale %>% 
  group_by(famid) %>% 
  mutate_at(c(5:88), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() %>% 
  select(-famid) %>% 
  cov(use = "na.or.complete") %>% 
  as.data.frame() -> cov_mat_males_all

cov_mat_males_all %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  mynamestheme +
  ggtitle("male VOC and trait history trait covariance matrix")+
  scale_fill_gradient2(low = "#0000FF", mid = "#FFFFFF", high ="#FF0000")+
  theme(axis.text.x = element_text(angle = 90))
```


#Correlation matrix females  traits
```{r}
cov_mat_fems_traits <- as.matrix(cov_mat_fems_traits)
cor_mat_fems_traits <- (cov2cor(cov_mat_fems_traits))
females_life <- corrplot(cor_mat_fems_traits, title= "Correlation matrix females life history traits", tl.col = "black", mar=c(0,2,1,1))
```
#Correlation matrix females all traits
```{r}
cov_mat_fems_all <- as.matrix(cov_mat_fems_all)
cor_mat_fems_all <- (cov2cor(cov_mat_fems_all))
females_all <- corrplot(cor_mat_fems_all, title= "Correlation matrix females life history traits", tl.col = "black", mar=c(0,2,1,1))
```

#Correlation matrix of male life history
```{r}
cov_mat_male_traits <- as.matrix(cov_mat_male_traits)
cor_mat_male_traits <- (cov2cor(cov_mat_male_traits))
males_life <- corrplot(cor_mat_male_traits, title= "Correlation matrix males VOC", tl.col = "black", mar=c(0,2,1,1))
```

#Correlation matrix male all
```{r}
cov_mat_males_all <- as.matrix(cov_mat_males_all)
cor_mat_males_all <- (cov2cor(cov_mat_males_all))
males_all <- corrplot(cor_mat_males_all, title= "Correlation matrix males voc", tl.col = "black", mar=c(0,2,1,1))
```


#All traits by filtering with only families shared between females and females. Plotted females vs females
All traits filtered females v females covariance
```{r}
clean_master_log_scaled %>% 
  filter(ssex == "m") %>% 
  group_by(famid) %>% 
  mutate_at(c(4:88), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct() -> male_data


clean_master_log_scaled %>% 
  filter(ssex == "f") %>% 
  group_by(famid) %>% 
  mutate_at(c(4:88), mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-c(sampid, ssex, raw_repro)) %>% 
  distinct()  %>% 
  filter(famid %in% male_data$famid)-> female_data

# Use only the families that have both males and females
test_cov <- cov(male_data[,2:85], female_data[,2:85], use = "pairwise.complete.obs")
test_cor <- cor(male_data[,2:85], female_data[,2:85])


test_cov %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
  labs(x="female", y="male")+
  ggtitle("Covariance matrix of all for males vs females")+
  mynamestheme+
  scale_fill_gradient2(low = "#0000FF", mid = "#FFFFFF", high ="#FF0000")+
  theme(axis.text.x = element_text(angle = 90))

```

```{r}
#Correlation matrix
test_cor %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "x") %>% 
  gather(key = "y", value = "value", -x) %>% 
  ggplot(aes(x = x, y = y, fill = value)) +
  geom_tile() +
labs(x="female", y="male")+
  ggtitle("Correlation matrix of all traits for males and females")+
  mynamestheme+
  scale_fill_gradient2(low = "#0000FF", mid = "#FFFFFF", high ="#FF0000")+
  theme(axis.text.x = element_text(angle = 90))
```

#Subtracting correlation matrices
```{r}
#Subtracting male and femlae life history correlation matrices

as.matrix(cor_mat_fems_traits) #Set data as matrix
as.matrix(cor_mat_male_traits) #Set data as matrix

#Plot
minus_mat_traits <- abs(cor_mat_male_traits - cor_mat_fems_traits)
corrplot(minus_mat_traits,  type = "upper", tl.col = "black", tl.srt = 60, tl.cex = 5, mar = c(0,0,2,0), title = "Difference between males and females life history trait") 

minus_mat_traits[minus_mat_traits == 1] <- NA #drop perfect
minus_mat_traits[abs(minus_mat_traits) < 0.5] <- NA # drop less than abs(0.5)
minus_mat_traits_sort <- na.omit(melt(minus_mat_traits)) # melt! 
minus_mat_traits_sort[order((minus_mat_traits_sort$value)),] # sort

```
```{r}
#Subtracting male and female all matrices

as.matrix(cor_mat_fems_all) #Set data as matrix
as.matrix(cor_mat_males_all) #Set data as matrix

#Plot
minus_mat_all <- abs(cor_mat_males_all - cor_mat_fems_all)
minus_mat_all[upper.tri(minus_mat_all)] <- NA
corrplot(minus_mat_all,  tl.col = "black", tl.srt = 60, tl.cex = .8, mar=c(0,2,1,1), title = "Difference between males and females life history traits and volatiles") 

minus_mat_all[minus_mat_all == 1] <- NA #drop perfect
minus_mat_all[abs(minus_mat_all) < 0.5] <- NA # drop less than abs(0.5)
minus_mat_all_sort <- na.omit(melt(minus_mat_all)) # melt! 
minus_mat_all_sort[order((minus_mat_all_sort$value)),] # sort

write.csv(minus_mat_all_sort, "cleandata/minus_matrix_all_sort.csv")

```






