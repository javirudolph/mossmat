---
title: "Growth_Development_Traits_cleaning_data"
author: "Leslie Kollar"
date: "11/25/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.width = 14, fig.height = 6)
```

## Data cleaning for life history traits
```{r libraries}
library(tidyverse)
library(vegan)
library(plotly)
library(corrplot)
library(ggpubr)
library(ggmosaic)
```


```{r dataload}
setwd("/Users/lesliekollar/Desktop/Moss_matrix/")
data_traits <- read.csv("rawdata/Data_Growth_experiment_summer_2017_not_all.csv")
```

```{r}
#Lots of DIV/0
data_traits$Week_3_Circularity <- as.numeric(str_replace(data_traits$Week_3_Circularity, "#DIV/0!", "NA"))
data_traits$Days_until_gametophores <- as.numeric(str_replace(data_traits$Days_until_gametophores, "#DIV/0!", "NA"))
data_traits$Total_Gametophores <- as.numeric(str_replace(data_traits$Total_Gametophores,"#DIV/0!", "NA"))
data_traits$Week_3_area <- as.numeric(str_replace(data_traits$Week_3_area, "#DIV/0!", "NA"))
data_traits$Week_3_perimeter <- as.numeric(str_replace(data_traits$Week_3_perimete, "#DIV/0!", "NA"))

#Filtering out rows with NAs because scale doees not like NA
data_traits %>% 
   filter_all(any_vars(is.na(.)))

data_traits[is.na(data_traits)] <- 0
```

```{r}
# Change variable names and fix sample ID names with spaces, or parentheses

trait <- data_traits %>% 
  drop_na(Family) %>% 
  mutate(Sample = str_replace_all(Sample, "\\(.*\\)", ""),
         Sample = str_trim(Sample, side = "both"),
         Sex = str_to_lower(as.character(Sex))) %>% # Sex on lower case only
  mutate_at(vars(starts_with("Week_3_area")), as.numeric) %>% # Make them all numeric 
  group_by(Family) %>% 
  arrange(Sample, .by_group = TRUE) %>% # Order by family number
  ungroup

trait$Week_3_Circularity <- as.numeric(trait$Week_3_Circularity)



```



## Checking for outliers and removing them
```{r}
#Visually check for outliers or values that do not make sense for area
trait[,5] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()

#Remove area week 3 outlier
outliers <- which(trait$Week_3_area>50)
trait[outliers,]

trait$Week_3_area[outliers] <- (trait$Week_3_area[outliers] / 1000)
                                
#Visually check for outliers or values that do not make sense for perimeter
trait[,6] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()

#Remove perimeter week 3 outlier
outliers <- which(trait$Week_3_perimeter>30)
trait[outliers,]

trait$Week_3_perimeter[outliers] <- (trait$Week_3_perimeter[outliers] / 1000)      


#Remove circularity week 3 outlier
trait[,7] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()

outliers <- which(trait$Week_3_Circularity>10)
trait[outliers,]

trait$Week_3_Circularity[outliers] <- (trait$Week_3_Circularity[outliers] / 1000) 
                                     
#Remove Days Until Gam--- really are those outliers though?
trait[,8] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()

#Remove Total--- I dont think these are outliers either...
trait[,9] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()

#Double Check
trait[,5:6] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()

trait[,7] %>% 
  gather(key = "trait", value = "value") %>% 
  drop_na() %>% 
  ggplot(aes(x = trait, y = value)) + 
  geom_boxplot()

trait[,c(1, 5:9)] %>% 
  drop_na() %>% 
  distinct()-> gro_dev_data
                                                                     
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

## Histogram of raw data
```{r}

#I think we can use the raw data for these traits moving forward. 
trait %>% 
  select(-c(Family, Sample, Sex, Plate)) %>% 
  gather(key = "trait", value = "raw_values") %>% 
  ggplot(aes(x = raw_values, y = ..density..)) +
  geom_histogram(na.rm = TRUE, fill = "#8e9998") +
  facet_wrap( ~ trait, scales = "free")
#Remove Sex=x
trait<-trait[!(trait$Sex=="x"),]

#saveRDS( , "cleandata/scaled_traits_Nov_26")
```

```{r}
#Scaling the traits and not log transforming them
names(trait)
trait %>% 
  #mutate_at(c(5:9), list(~ log10(. + 1))) %>% 
  mutate_at(c(5:9), scale) -> scaled_traits

scaled_traits %>% 
  select(-c(Family, Sample, Sex, Plate)) %>% 
  gather(key = "trait", value = "raw_values") %>% 
  ggplot(aes(x = raw_values, y = ..density..)) +
  geom_histogram(na.rm = TRUE, fill = "#7e9bcc") +
  facet_wrap( ~ trait, scales = "free")

scaled_traits <- scaled_traits[,1:9]

```




```{r}
#saveRDS(scaled_traits, "cleandata/Final_growth_dev_traits.RDS")
```

##Running ordination on growth and development traits
```{r}
#Run PCA
scaled_pca <- rda(scaled_traits[,5:9])



# Figure for log transformed data
biplot(scaled_pca, display = c("sites", 
                   "species"),
       type = c("text",
                "points"))
ssex.colors <- levels(factor(trait$Sex))
ordihull(scaled_pca, group = factor(trait$Sex),
         col = c("green","blue"))
legend("topright", 
       col = c("green", "blue"),
       lty = 1,
       legend = ssex.colors)



```

```{r}
### PCA reducation chosing axes that explain 80% of the total variance and eigenvalues have to be above 1
#Scree plot shows a lot of the variation is explained in PC1
screeplot(scaled_pca)
abline(a=1,b=0)

## How do we know how many to chose?
summary(scaled_pca)

#Expressed as cummalitve percentages
round(cumsum(100*scaled_pca$CA$eig/sum(scaled_pca$CA$eig)),2)

```

##Practice if we want to pull out the first 3 eigenvalues 
I am not sure how to interpret this because it runs each eigenvalue through but how do we contribute this to a certain trait?
```{r}
data.lm <- lm(scaled_pca$CA$u[,1:3]~ trait$Sex)
summary(data.lm)
```
First three PC account for 88% of the total variation. I would absolutely keep the first three.

#Univariate

```{r}

#Among family variances for week 3 perimeter
Among_Family_P <- lme(Week_3_perimeter ~ Sex, random =~ 1|Family + 1|Plate, data = trait)
anova(Among_Family_P)
summary(Among_Family_P)

#Compute a model where the effect of sex is estimated
unrestricted_fit= lmer(
  formula = Week_3_perimeter ~ Sex + (1|Family) + (1|Plate),data = trait, REML = F)
BIC(unrestricted_fit)
AIC(unrestricted_fit)

#Compute a model where the effect of sex is not estimated
restricted_fit= lmer(
  formula = Week_3_perimeter ~  (1|Family) + (1|Plate) ,data = trait, REML = F)
BIC(restricted_fit)
AIC(restricted_fit)

#Compute the AIC-corrected log-base-2 likelihood ratio
#What is this?
(AIC(restricted_fit)-AIC(unrestricted_fit))*log2(exp(1))
```
```{r}

#Among family variances for week 3 area
Among_Family_A <- lme(Week_3_area ~ Sex, random =~ 1|Family+ 1|Plate, data = trait)
anova(Among_Family_A)
summary(Among_Family_A)

#Compute a model where the effect of sex is estimated
unrestricted_fit= lmer(
  formula = Week_3_area ~ Sex + (1|Family)+ (1|Plate), data = trait, REML = F)
BIC(unrestricted_fit)
AIC(unrestricted_fit)

#Compute a model where the effect of sex is not estimated
restricted_fit= lmer(
  formula = Week_3_area ~  (1|Family)+ (1|Plate) ,data = trait, REML = F)
BIC(restricted_fit)
AIC(restricted_fit)

#Compute the AIC-corrected log-base-2 likelihood ratio
#What is this?
(AIC(restricted_fit)-AIC(unrestricted_fit))*log2(exp(1))
```


```{r}
#Among family variances for Days until Gam.
Among_Family_D <- lme(Days_until_gametophores~ Sex, random =~ 1|Family + 1|Plate, data = trait)
anova(Among_Family_D)
summary(Among_Family_D)

#Compute a model where the effect of sex is estimated
unrestricted_fit= lmer(
  formula =Days_until_gametophores ~ Sex + (1|Family) + (1|Plate),data = trait, REML = F)
BIC(unrestricted_fit)
AIC(unrestricted_fit)

#Compute a model where the effect of sex is not estimated
restricted_fit= lmer(
  formula =Days_until_gametophores ~  (1|Family)+ (1|Plate) ,data = trait, REML = F)
BIC(restricted_fit)
AIC(restricted_fit)

#Compute the AIC-corrected log-base-2 likelihood ratio
#What is this?
(AIC(restricted_fit)-AIC(unrestricted_fit))*log2(exp(1))
```

```{r}

#Among family variances for week 3 circularity
Among_Family_C <- lme(Week_3_Circularity~ Sex, random =~ 1|Family+ 1|Plate, data = trait)
anova(Among_Family_C)
summary(Among_Family_C)

#Compute a model where the effect of sex is estimated
unrestricted_fit= lmer(
  formula = Week_3_Circularity ~ Sex + (1|Family)+ (1|Plate),data = trait, REML = F)
BIC(unrestricted_fit)
AIC(unrestricted_fit)

#Compute a model where the effect of sex is not estimated
restricted_fit= lmer(
  formula =Week_3_Circularity ~  (1|Family)+ (1|Plate) ,data = trait, REML = F)
BIC(restricted_fit)
AIC(restricted_fit)

#Compute the AIC-corrected log-base-2 likelihood ratio
#What is this?
(AIC(restricted_fit)-AIC(unrestricted_fit))*log2(exp(1))
```

```{r}
#Among family variances for total gametophores
Among_Family_T <- lme(Total_Gametophores~ Sex, random =~ 1|Family+ 1|Plate, data = trait)
anova(Among_Family_T)
summary(Among_Family_T)

#Compute a model where the effect of sex is estimated
unrestricted_fit= lmer(
  formula = Total_Gametophores ~ Sex + (1|Family)+ (1|Plate),data = trait, REML = F)
BIC(unrestricted_fit)
AIC(unrestricted_fit)

#Compute a model where the effect of sex is not estimated
restricted_fit= lmer(
  formula =Total_Gametophores ~  (1|Family)+ (1|Plate) ,data = trait, REML = F)
BIC(restricted_fit)
AIC(restricted_fit)

#Compute the AIC-corrected log-base-2 likelihood ratio
#What is this?
(AIC(restricted_fit)-AIC(unrestricted_fit))*log2(exp(1))
```